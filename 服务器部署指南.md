# Discord Bot 服务器部署完整指南

## 第一步：下载配置文件到服务器

在你的VPS服务器上执行以下命令：

```bash
# 创建临时目录
mkdir -p ~/discord-bot-deploy
cd ~/discord-bot-deploy

# 下载nginx配置文件（选择一个方法）
# 方法1：如果你有git
git clone <你的代码仓库地址> .

# 方法2：手动创建配置文件
cat > nginx_simple_config.conf << 'EOF'
server {
    listen 80;
    listen [::]:80;
    server_name www.tdindicator.top tdindicator.top;
    
    # 重定向HTTP到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.tdindicator.top tdindicator.top;

    # SSL证书配置（使用你现有的证书路径）
    ssl_certificate /etc/letsencrypt/live/www.tdindicator.top/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.tdindicator.top/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 现有网站根目录（保持你当前的网站）
    root /var/www/html;
    index index.html index.htm index.php;

    # 现有网站默认location
    location / {
        try_files $uri $uri/ =404;
    }

    # Discord Bot Webhook - TradingView数据接收
    location /webhook/ {
        proxy_pass http://127.0.0.1:5000/webhook/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        client_max_body_size 10M;
    }

    # Discord Bot API - 消息发送等功能
    location /api/ {
        proxy_pass http://127.0.0.1:5000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        client_max_body_size 10M;
    }

    # Discord Bot状态监控
    location /bot-status {
        proxy_pass http://127.0.0.1:5000/api/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Discord Bot API文档
    location /bot-api {
        proxy_pass http://127.0.0.1:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 安全头部
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}
EOF
```

## 第二步：部署nginx配置

```bash
# 1. 备份现有nginx配置
sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.backup.$(date +%Y%m%d_%H%M%S)

# 2. 复制新配置到nginx目录
sudo cp nginx_simple_config.conf /etc/nginx/sites-available/tdindicator.top

# 3. 激活配置
sudo ln -sf /etc/nginx/sites-available/tdindicator.top /etc/nginx/sites-enabled/

# 4. 测试nginx配置
sudo nginx -t

# 5. 如果测试通过，重新加载nginx
sudo systemctl reload nginx

# 6. 检查nginx状态
sudo systemctl status nginx
```

## 第三步：验证部署

测试Discord Bot API是否正常工作：

```bash
# 测试健康检查
curl https://www.tdindicator.top/bot-status

# 测试webhook（如果Bot正在运行）
curl -X POST https://www.tdindicator.top/webhook/tradingview \
     -H 'Content-Type: application/json' \
     -d '{"symbol":"AAPL","action":"buy","price":150.00}'
```

## 第四步：启动Discord Bot

在服务器上启动你的Discord Bot：

```bash
# 进入你的bot目录
cd /path/to/your/discord-bot

# 启动bot（确保.env文件包含所有必要的环境变量）
python3 main_with_api.py
```

## 可用的API端点

部署完成后，以下端点将可用：

- **Webhook**: `https://www.tdindicator.top/webhook/tradingview`
- **健康检查**: `https://www.tdindicator.top/bot-status`
- **API文档**: `https://www.tdindicator.top/bot-api`
- **发送消息**: `https://www.tdindicator.top/api/send-message`
- **发送私信**: `https://www.tdindicator.top/api/send-dm`
- **发送图表**: `https://www.tdindicator.top/api/send-chart`

## 故障排除

如果遇到问题：

1. **检查nginx错误日志**:
   ```bash
   sudo tail -f /var/log/nginx/error.log
   ```

2. **检查nginx配置语法**:
   ```bash
   sudo nginx -t
   ```

3. **确认Discord Bot正在运行**:
   ```bash
   ps aux | grep python
   ```

4. **检查端口5000是否被占用**:
   ```bash
   netstat -tlnp | grep 5000
   ```

## 重要提醒

- 确保你的Discord Bot在端口5000上运行
- 确保SSL证书路径正确
- 这个配置保持你现有网站的功能，只是添加了Bot的API端点