# 端口配置详细说明

## 端口使用情况

### 对外开放的端口（防火墙需要开放）
- **80 (HTTP)**: 自动重定向到HTTPS
- **443 (HTTPS)**: 处理所有外部请求
- **22 (SSH)**: 服务器管理（通常已开放）

### 内部端口（无需对外开放）
- **5000**: Discord Bot运行端口（仅本地访问127.0.0.1:5000）

## 访问流程

```
外部请求 → nginx (443端口) → 内部转发 → Discord Bot (5000端口)

具体示例：
TradingView Webhook
↓
https://www.tdindicator.top/webhook/tradingview (443端口)
↓
nginx内部转发
↓
http://127.0.0.1:5000/webhook/tradingview (内部5000端口)
↓
Discord Bot处理
```

## 防火墙配置检查

### 检查当前开放端口
```bash
# 查看防火墙状态
sudo ufw status

# 查看监听端口
sudo netstat -tlnp | grep :443
sudo netstat -tlnp | grep :80
```

### 如果端口80/443未开放，需要执行
```bash
sudo ufw allow 80
sudo ufw allow 443
sudo ufw reload
```

### 验证端口5000不对外开放（安全检查）
```bash
# 这个命令应该显示5000端口只监听127.0.0.1
sudo netstat -tlnp | grep :5000
# 预期输出: tcp 127.0.0.1:5000 0.0.0.0:* LISTEN
```

## Discord Bot连接验证

### Bot启动后的端口检查
```bash
# 检查Discord Bot是否在5000端口运行
curl http://127.0.0.1:5000/api/health

# 检查外部访问是否正常
curl https://www.tdindicator.top/bot-status
```

## 安全说明

1. **端口5000仅内部访问**: 外部无法直接连接，提高安全性
2. **nginx作为反向代理**: 处理SSL、安全头、请求过滤
3. **防火墙保护**: 只开放必要的80/443端口

## 如果遇到连接问题

### 1. 检查nginx是否正常运行
```bash
sudo systemctl status nginx
sudo nginx -t
```

### 2. 检查Discord Bot是否启动
```bash
ps aux | grep python
curl http://127.0.0.1:5000/api/health
```

### 3. 检查防火墙设置
```bash
sudo ufw status
sudo iptables -L
```

### 4. 查看nginx访问日志
```bash
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```