# Discord图表机器人使用指南

## 功能概述

升级后的Discord机器人现在支持：
1. **监控指定频道** - 只在设定的频道中响应@bot消息
2. **股票图表生成** - 调用chart-img API获取实时图表
3. **私信发送** - 将图表通过私信发送给请求用户
4. **频道通知** - 在原频道提示用户图表已发送

## 使用方法

### 在监控频道中输入股票命令（可以@机器人或直接输入）：

```
AAPL,1h
NASDAQ:GOOG,15m  
SPY,1d
TSLA,4h
@TDbot-tradingview MSFT,1h
```

### 支持的时间框架：
- **分钟**: 1m, 5m, 15m, 30m
- **小时**: 1h, 2h, 4h, 6h, 12h  
- **天**: 1d
- **周**: 1w
- **月**: 1M

### 每日请求限制：
- **限制次数**: 每位用户每天最多3次图表请求
- **配额查询**: 使用 `!quota` 命令查看剩余次数
- **重置时间**: 每日UTC午夜0点自动重置

### 机器人响应流程：

1. ⏳ **处理中** - 机器人添加等待反应
2. 📊 **API调用** - 获取股票图表数据
3. 💌 **发送私信** - 图表发送到用户私信
4. ✅ **频道通知** - 在原频道确认发送成功
5. ❌ **错误处理** - 如果失败，显示错误信息

## 配置说明

### 环境变量（Secrets）：
- `MONITOR_CHANNEL_ID` - 监控的Discord频道ID
- `CHART_IMG_API_KEY` - chart-img API密钥
- `LAYOUT_ID` - TradingView图表布局ID
- `TRADINGVIEW_SESSION_ID` - TradingView会话ID
- `TRADINGVIEW_SESSION_ID_SIGN` - TradingView会话签名

### 技术指标加载优化：
- 使用Shared Layout API访问您的自定义TradingView布局
- 支持有限参数：symbol、interval、width(1920)、height(1080)覆盖
- 180秒超时设置，适配复杂指标处理
- 直接返回PNG图片数据
- TradingView会话凭证支持私有布局访问
- 完全自定义的TradingView布局和技术指标
- 支持社区脚本和私有指标（根据TradingView订阅计划）

### 示例响应：

**用户输入：**
```
AAPL,1h
```

**机器人私信：**
```
📈 AAPL 1h 技术分析图表
[图表图片附件]
```

**频道回复：**
```
@用户名 📊 AAPL 1h 图表已生成并发送到您的私信中
```

## 错误处理

### 常见错误和解决方法：

1. **格式错误**
   - 错误: `无效命令`
   - 回复: `请使用正确格式：AAPL,1h 或 NASDAQ:GOOG,15m`

2. **不支持的时间框架**
   - 错误: `AMZN,15h` (15h不是有效时间框架)
   - 回复: `❌ 无法获取 AMZN 15h 图表: 不支持的时间框架`
   - 解决: 使用支持的时间框架: 1m,5m,15m,30m,1h,2h,4h,6h,12h,1d,1w,1M

2. **私信被阻止**
   - 错误: Discord隐私设置阻止私信
   - 回复: `无法发送私信，请检查您的隐私设置`

3. **API调用失败**
   - 错误: chart-img API异常
   - 回复: `❌ 无法获取 AAPL 1h 图表: API调用失败`

4. **系统错误**
   - 错误: 内部处理异常
   - 回复: `处理请求时发生错误，请稍后重试`

## 高级功能

### 同时支持两种模式：
- **监控频道模式** - 在指定频道处理图表请求
- **webhook转发模式** - 在其他频道继续webhook转发功能

### API集成：
- 机器人同时提供HTTP API服务（端口5000）
- 支持n8n工作流集成
- 可通过API直接发送图表到用户私信